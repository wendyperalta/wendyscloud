/*!CK:4271220824!*//*1379677139,182141259*/

if (self.CavalryLogger) { CavalryLogger.start_js(["GK3bz"]); }

__d("MusicProviders",[],function(a,b,c,d,e,f){e.exports=a.MusicProviders={SPOTIFY:'open.spotify.com'};});
__d("SpotifyAjaxRequest",["ArbiterMixin","ErrorUtils","JSLogger","URI","copyProperties","emptyFunction"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('ErrorUtils'),i=b('JSLogger'),j=b('URI'),k=b('copyProperties'),l=b('emptyFunction'),m=i.create('music_spotify'),n=function(){this._request=null;this._data={};this._option={timeout:30000,method:'GET'};this._timeout=null;};k(n,{LOAD_ERROR:'LOAD_ERROR',TIMEOUT_ERROR:'TIMEOUT_ERROR',PARSE_ERROR:'PARSE_ERROR',isSupported:function(){return window.XMLHttpRequest&&typeof XDomainRequest!=='undefined'||('withCredentials' in new XMLHttpRequest());}});k(n.prototype,g,{getDebugData:function(){return {uri:this._uri.toString(),data:this._data,options:this._option};},setData:function(o){this._data=o;return this;},setOption:function(o,p){this._option[o]=p;return this;},setURI:function(o){this._uri=j(o);return this;},makeRequestAndOpen:function(){var o=new XMLHttpRequest();if('withCredentials' in o){o.open(this._option.method,this._uri.toString(),true);}else if(typeof XDomainRequest!=='undefined'){o=new XDomainRequest();o.open(this._option.method,this._uri.toString());}else{m.error('not_supported',this.getDebugData());throw new Error('SpotifyAjaxRequest: not supported');}return o;},send:function(){if(this.inform('initial',this)!==false){this._uri.addQueryData(k({cors:''},this._data));this._request=this.makeRequestAndOpen();this._request.ontimeout=l;this._request.onprogress=l;this._request.onload=this._parseResult.bind(this);this._request.onerror=this._dispatchResult.bind(this,'error',{error:{type:n.LOAD_ERROR,message:'the request failed to load at: '+this._uri}});if(this._option.timeout>0)this._timeout=this._dispatchResult.bind(this,'timeout',{error:{type:n.TIMEOUT_ERROR,message:'a timeout occurred after '+this._option.timeout+'ms'}}).defer(this._option.timeout,false);h.applyWithGuard(this._request.send,this._request,null,function(o){m.error('send_error',o);}.bind(this));}return this;},abort:function(){clearTimeout(this._timeout);try{this._request.abort();}catch(o){}this._request=null;this.inform('finish');return this;},_dispatchResult:function(o,p){clearTimeout(this._timeout);this.inform.bind(this,'finish',p).defer();this.inform(o,p);},_parseResult:function(){var o,p,q,r;try{o=this._request.responseText||'';}catch(s){p=n.LOAD_ERROR;q='responseText not available - '+s.message;}if(!p)try{r=JSON.parse(o);}catch(s){p=n.PARSE_ERROR;q='exception parsing JSON - '+s.message;}if(!p&&!r){p=n.PARSE_ERROR;q='empty JSON';}if(p){this._dispatchResult('error',{error:{type:p,message:q}});}else this._dispatchResult(r.error?'error':'success',r);}});e.exports=n;});
__d("SpotifyRemote",["ArbiterMixin","AsyncRequest","Bootloader","Dialog","DOM","JSLogger","MusicConstants","MusicDiagnostics","MusicEvents","MusicProviders","Run","SpotifyAjaxRequest","URI","UserAgent","copyProperties","emptyFunction","ge"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('AsyncRequest'),i=b('Bootloader'),j=b('Dialog'),k=b('DOM'),l=b('JSLogger'),m=b('MusicConstants'),n=b('MusicDiagnostics'),o=b('MusicEvents'),p=b('MusicProviders'),q=b('Run'),r=b('SpotifyAjaxRequest'),s=b('URI'),t=b('UserAgent'),u=b('copyProperties'),v=b('emptyFunction'),w=b('ge'),x=l.create('music_spotify'),y=null;function z(){}(function(){var aa=window.location.protocol==='https:';u(z.prototype,g,{PROTOCOL_VERSIONS:[9],serial:1,manualPlay:false,showLoggingin:false,oauthTokenInvalid:false,config:{play_now_url:'/ajax/music/spotify_play_now.php?init_only',oauth_step:8,set_installed_url:'/ajax/music/spotify/installed.php',csrf_uri:'/ajax/music/spotify/set_csrf.php',fetch_oauth_url:'/ajax/music/spotify/auth.php?going_online',retryPeriod:3000,iframeUpdatePeriod:10000,iframeTryCycles:3,longPollPeriod:60000,optimisticPlayNowTime:1000,loggingInTimeout:15000,defaultTimeout:4000,pingWebHelperTimeout:m.CONFIG.PARTNER_TIMEOUT,expBackoffFactor:1.2,maxPollInterval:2200,apPollTimeout:8000},responseCallback:v,tokens:{spotify_csrf:'',spotify_oauth:'',last_timestamp:0},serverConfig:{url:window.location.protocol+'//'+((Math.random()*10000)|0)+'.spotilocal.com',webhelperPort:aa?4370:4380,path:'/',callbackParam:'callback',ops:{STATUS:'remote/status.json',RESUME:'remote/pause.json?pause=false',PAUSE:'remote/pause.json?pause=true',PLAY:'remote/play.json',VERSION:'service/version.json?service=remote',GET_IFRAME_RESPONSE:'csrf/getFbCsrfToken.html',LOGIN:'remote/login.json'}},STATES:{OFFLINE:'OFFLINE',RESIGNED:'RESIGNED',SEARCHING:'SEARCHING',AUTHENTICATING:'AUTHENTICATING',LOGGED_OUT_AND_WAITING:'LOGGED_OUT_AND_WAITING',FETCHING_OAUTH:'FETCHING_OAUTH',IFRAME_POLLING:'IFRAME_POLLING',RETRYING_TOKENS:'RETRYING_TOKENS',WAITING_TO_AUTH:'WAITING_TO_AUTH',LOGGING_IN:'LOGGING_IN',ONLINE:'ONLINE'},init:function(ba,ca){this._iframeTryCount=0;this._providerArgs=ca;this._switchToState(this.STATES.OFFLINE);ba&&this.setResponseCallback(ba);this.uri=new s(this.serverConfig.url||'');this.uri.setPort(this.serverConfig.webhelperPort);this.uri.setPath(this.serverConfig.path||'');if(ca.fb_csrf)this.fb_csrf=ca.fb_csrf;this._hasXDomainXHR=r.isSupported();},persistSearchingFor:function(ba){this._persistFor=ba;var ca=this._persistentLoopTimer;this._resetPersistenceTimers();if(ca&&this._persistFor)this._persistentLoopTimer=this._stopPersisting.bind(this).defer(this._persistFor*1000,false);},serviceRunning:function(){switch(this.state){case this.STATES.LOGGED_OUT_AND_WAITING:case this.STATES.IFRAME_POLLING:case this.STATES.RETRYING_TOKENS:case this.STATES.FETCHING_OAUTH:case this.STATES.LOGGING_IN:case this.STATES.ONLINE:return true;default:return false;}},attemptGoOnline:function(ba){this.manualPlay=ba;if(!this._hasXDomainXHR&&aa||t.opera()){if(this.manualPlay)j.bootstrap('/ajax/music/spotify/unsupported_browser.php');return;}switch(this.state){case this.STATES.OFFLINE:case this.STATES.RESIGNED:this._switchToState(this.STATES.SEARCHING);this.responseCallback(m.DIAGNOSTIC_EVENT.SEARCHING);if(this._hasXDomainXHR){this._pingWebHelper();}else i.loadModules(['SpotifyJSONPRequest'],function(ca){y=ca;this._pingWebHelper();}.bind(this));break;case this.STATES.LOGGED_OUT_AND_WAITING:if(this.manualPlay){this._switchToState(this.STATES.LOGGING_IN);this._send(m.STATUS_CHANGE_OP.LOGIN);}}this.persistSearchingFor(this._persistFor);},reconnect:function(){if(this.state===this.STATES.IFRAME_POLLING){this._cleanupIframe();}else if(this.state===this.STATES.FETCHING_OAUTH){this.fetchedOauth=true;this.oauthTokenInvalid=false;}else{x.error('invalid_reconnect',this.state);return;}this._switchToState(this.STATES.RETRYING_TOKENS);this._send(m.STATUS_CHANGE_OP.STATUS);},setShowLoggingin:function(ba){this.showLoggingin=ba;},setTokens:function(ba,ca){ba=ba||{};var da=this.tokens.last_timestamp<ca;if(ba.spotify_csrf&&(!this.tokens.spotify_csrf||da))this.tokens.spotify_csrf=ba.spotify_csrf;if(ba.spotify_oauth&&(!this.tokens.spotify_oauth||da))this.tokens.spotify_oauth=ba.spotify_oauth;if(da&&(ba.spotify_csrf||ba.spotify_oauth))this.tokens.last_timestamp=ca;},goOnline:function(){x.log('go_online',{uri:this.uri.toString(),from_state:this.state});this._switchToState(this.STATES.ONLINE);this._stopPersisting();this.oauthTokenInvalid=false;this._iframeTryCount=0;this.responseCallback(m.DIAGNOSTIC_EVENT.ONLINE);this._startPolling();new h(this.config.set_installed_url).setData({set:true,csrf:this.tokens.spotify_csrf}).send();},goOffline:function(){x.log('go_offline',{uri:this.uri.toString(),from_state:this.state});this._switchToState(this.STATES.OFFLINE);clearTimeout(this._authenticatingRetry);this._cleanupIframe();this._stopPersisting();this.oauthTokenInvalid=false;this.fetchedOauth=false;this._iframeTryCount=0;this.responseCallback(m.DIAGNOSTIC_EVENT.OFFLINE);},displayError:function(ba,ca){x.error('display_error',{error_code:ba,extra_data:ca});var da=this._getDisplayErrorParams(ba,ca);j.bootstrap('/ajax/music/play_error.php',da);},_getDisplayErrorParams:function(ba,ca){var da={code:ba,provider:p.SPOTIFY};ca=ca||{};if(ca.error_url)da.url=ca.error_url;if(ca.song)da.song=ca.song;return da;},launchPlayNowDialog:function(ba){if(this.state!==this.STATES.LOGGED_OUT_AND_WAITING&&this.serviceRunning())return;this._resetLaunchSubscription();var ca=this._launchPlayNow.bind(this,ba);this.prePlayNowLaunchTimer=ca.defer(this.config.optimisticPlayNowTime,false);this.launchSubscription=this.subscribe([m.DIAGNOSTIC_EVENT.STATE_CHANGE,m.DIAGNOSTIC_EVENT.WRONG_VERSION],function(da,ea){if(da===m.DIAGNOSTIC_EVENT.WRONG_VERSION){this._resetLaunchSubscription();}else switch(ea.to){case this.STATES.OFFLINE:case this.STATES.RESIGNED:this._resetLaunchSubscription();ca();break;case this.STATES.AUTHENTICATING:this._resetLaunchSubscription();n.userAction.curry(p.SPOTIFY,n.LAUNCH_NOT_NEEDED).defer();break;}}.bind(this));this.attemptGoOnline(true);},send:function(ba,ca){if(this.state===this.STATES.ONLINE){this.responseCallback(m.DIAGNOSTIC_EVENT.LOG_SEND_OP,{op:ba,params:ca});this._send(ba,m.sanitizeForProviders(ca));}else this.responseCallback(m.DIAGNOSTIC_EVENT.REQUEUE_OP,{op:ba,params:ca});},setResponseCallback:function(ba){this.responseCallback=ba;},_send:function(ba,ca){var da=false;if(ba===m.OP.PLAY&&ca){da={uri:ca.uri};if(ca.playlist){da.context=ca.playlist;}else if(ca.album){da.context=ca.album;}else if(ca.song_list){var ea=ca.song_list.indexOf(ca.uri),fa=ca.song_list.map(function(ja){return ja.replace(/.*\//,'');});da.context='spotify:trackset:'+escape(ca.title||'Facebook')+':'+fa.join(',');}if(ca.offset){var ga=Math.floor(ca.offset/60),ha=ca.offset%60;da.uri+='#'+ga+':'+ha;}if(ca.request_id)da.request_id=ca.request_id;if(ca.listen_with_friends)da.listen_with_friends=ca.listen_with_friends;}var ia=da||ca;if(ia&&ia.request_id)ia.request_id=ia.request_id+'';this._createOpRequest(ba,ia).send();n.sendUpdate.curry(p.SPOTIFY,ba,ia).defer();},_launchPlayNow:function(ba){this._resetLaunchSubscription();var ca=ba&&ba.context&&ba.context.button_id;j.bootstrap(this.config.play_now_url,ba,null,null,null,w(ca));},_resetLaunchSubscription:function(){clearTimeout(this.prePlayNowLaunchTimer);if(this.launchSubscription){var ba=this.launchSubscription;this.launchSubscription=undefined;this.unsubscribe(ba);}},_pingWebHelper:function(){this._createOpRequest(m.OP.VERSION).send();},_stopPersisting:function(){this._persistFor=0;this._resetPersistenceTimers();return this;},_resetPersistenceTimers:function(){clearTimeout(this._persistentLoopTimer);clearTimeout(this._persistentLoopIterationTimer);this._persistentLoopTimer=null;this.loopIterationTime=1000;},_pingWebHelperModeResign:function(){if(this._persistFor){var ba=this.loopIterationTime*this.config.expBackoffFactor;if(ba<this.config.maxPollInterval)this.loopIterationTime=ba;this._persistentLoopIterationTimer=this.attemptGoOnline.bind(this,this.manualPlay).defer(this.loopIterationTime,false);x.debug('persistence_connection_failed','retry in: '+(this.loopIterationTime/1000));this._switchToState(this.STATES.RESIGNED);}else this.goOffline();},_startPolling:function(){if(this.state!==this.STATES.ONLINE||!window.loaded)return false;q.onAfterLoad((function(){this._latestRequest=this._createOpRequest(m.STATUS_CHANGE_OP.STATUS,{returnon:'login,logout,play,error,ap',returnafter:this.config.longPollPeriod/1000});this._latestRequest.subscribe('finish',this._startPolling.bind(this));this._latestRequest.send();}).bind(this));},_pollForAP:function(){this._createOpRequest(m.STATUS_CHANGE_OP.STATUS,{returnon:'ap',returnafter:this.config.apPollTimeout/1000}).send();},_createOpRequest:function(ba,ca){if(!this.serverConfig.ops[ba]){x.error('invalid_op',ba);return false;}var da=this.config.defaultTimeout;if(ca&&ca.returnon){da=0;}else if(this.state===this.STATES.SEARCHING){da=this.config.pingWebHelperTimeout;}else if(this.state===this.STATES.LOGGING_IN)da=this.config.loggingInTimeout;var ea=this._hasXDomainXHR?new r():new y();ea.setOption('callbackParam',this.serverConfig.callbackParam).setOption('timeout',da).setData(u({csrf:this.tokens.spotify_csrf,oauth:this.tokens.spotify_oauth},(ca||{}))).setURI(this.uri.toString()+this.serverConfig.ops[ba]);x.debug('create_op_request',ea.getDebugData());ea.subscribe('success',this._respondToSuccess.bind(this,ba));ea.subscribe('error',this._respondToError.bind(this,ba));ea.subscribe('timeout',this._respondToError.bind(this,ba));return ea;},_respondToSuccess:function(ba,ca,da){x.debug('respond_to_success',{op:ba,response_data:da});if(da.hasOwnProperty('online')&&!da.online)if(this.state!=this.STATES.WAITING_TO_AUTH){this._switchToState(this.STATES.WAITING_TO_AUTH);this._pollForAP();return;}else{this.manualPlay&&this.displayError(4);this.goOffline();}switch(this.state){case this.STATES.SEARCHING:var ea=da.client_version,fa=da.version;if(this._isValidClient(ea,fa)){this._switchToState(this.STATES.AUTHENTICATING);this._send(m.STATUS_CHANGE_OP.STATUS);}else{x.error('connecting_schema_version_mismatch',{client_version:ea,protocol_version:fa});this.inform(m.DIAGNOSTIC_EVENT.WRONG_VERSION);if(this.manualPlay)j.bootstrap('/ajax/music/spotify/version_mismatch.php');this.goOffline();return;}break;case this.STATES.LOGGING_IN:case this.STATES.RETRYING_TOKENS:case this.STATES.AUTHENTICATING:this.goOnline();break;case this.STATES.WAITING_TO_AUTH:if(da.online){this.goOnline();}else{this.manualPlay&&this.displayError(4);this.goOffline();}break;case this.STATES.RESIGNED:case this.STATES.OFFLINE:return;}da=da?this._convertURIFields(da):{};this.error_count=0;this.responseCallback(ba,da);},_respondToError:function(ba,ca,da){switch(this.state){case this.STATES.SEARCHING:x.debug('connect_miss',this.uri.toString());return;case this.STATES.RESIGNED:case this.STATES.OFFLINE:x.debug('offline_or_resigned',this.state);return;}if(ba===m.OP.VERSION){x.debug('stray_version');return;}var ea=v,fa=da||{},ga=this._getError(fa.error.type);x.debug('respond_to_error',{op:ba,error_code:ga,payload:fa});switch(ga){case 'SERVICE_DEPENDENT_ERRORS':var ha=this._getError(fa.error.type,true),ia=this._getDisplayErrorParams(ha,fa);n.userAction.curry(p.SPOTIFY,m.DIAGNOSTIC_EVENT.SERVICE_ERROR,ia).defer();if(m.STATUS_CHANGE_OP[ba]&&o.inform(m.DIAGNOSTIC_EVENT.SERVICE_ERROR,ia)!==false&&m.ERROR[ha]!=='AUDIO_AD_PLAYING')this.displayError(ha,fa);break;case 'PARSE_ERROR':case 'LOAD_ERROR':case 'TIMEOUT_ERROR':case 'SERVICE_NOT_RESPONDING':case 'UNKNOWN_SERVICE':case 'UNKNOWN_METHOD':case 'ERROR_PARSING_REQUEST':clearTimeout(this._authenticatingRetry);if(ga=='SERVICE_NOT_RESPONDING'&&this.state===this.STATES.AUTHENTICATING){ea=this._pingWebHelperModeResign;break;}ea=this._loadError;if(this.state===this.STATES.AUTHENTICATING||this.state===this.STATES.RETRYING_TOKENS){this._authenticatingRetry=this._send.bind(this,m.STATUS_CHANGE_OP.STATUS).defer(this.config.retryPeriod,false);}else if(this.state===this.STATES.LOGGING_IN)this._authenticatingRetry=this._send.bind(this,m.STATUS_CHANGE_OP.LOGIN).defer(this.config.retryPeriod,false);break;case 'INVALID_OAUTH_FOR_CURRENT_USER':case 'NO_USER_LOGGED_IN':if(this.state===this.STATES.ONLINE||this.state===this.STATES.WAITING_TO_AUTH){x.debug('user_logged_out');this.goOffline();this._switchToState(this.STATES.LOGGED_OUT_AND_WAITING);return;}else if(this.state===this.STATES.LOGGING_IN){this.oauthTokenInvalid=true;if(!this.fetchedOauth){this._switchToState(this.STATES.FETCHING_OAUTH);new h(this.config.fetch_oauth_url).send();return;}ea=this._authError;}else if(this.manualPlay){this._switchToState(this.STATES.LOGGING_IN);this._send(m.STATUS_CHANGE_OP.LOGIN);}else this._switchToState(this.STATES.LOGGED_OUT_AND_WAITING);break;case 'EXPIRED_OAUTH_TOKEN':case 'LOGIN_BAD_CREDENTIALS':this.oauthTokenInvalid=true;if(!this.fetchedOauth){this._switchToState(this.STATES.FETCHING_OAUTH);new h(this.config.fetch_oauth_url).send();return;}ea=this._authError;break;case 'OAUTH_TOKEN_NOT_VERIFIED':case 'TOKEN_VERIFICATION_TIMEOUT':if(this.state!=this.STATES.WAITING_TO_AUTH){this._switchToState(this.STATES.WAITING_TO_AUTH);this._pollForAP();return;}ea=this._authError;break;case 'INVALID_CSRF_TOKEN':case 'AUTH_FAILED':case 'TOKEN_VERIFICATION_DENIED_TOO_MANY_REQUESTS':ea=this._authError;break;default:x.error('bad_op',{op:ba,payload:fa});break;}ea.call(this,ba,fa);},_loadError:function(ba,ca){x.debug('load_error',{op:ba,error_count:this.error_count+1,data:ca});this.goOffline();},_authError:function(ba,ca){x.error('auth_error',{op:ba,data:ca,error_code:this._getError(ca.error.type)});if(this.state===this.STATES.WAITING_TO_AUTH){this.manualPlay&&this.displayError(4);this.goOffline();return;}if(this.showLoggingin){this._launchPlayNow({step:10});this.showLoggingin=false;}this._cleanupIframe();if(this._iframeTryCount<=this.config.iframeTryCycles){this._switchToState(this.STATES.IFRAME_POLLING);this._makeIframePollRequest();this.responseCallback(m.DIAGNOSTIC_EVENT.IFRAME_POLLING);}else{if(this.manualPlay)j.bootstrap('/ajax/music/login_error.php');this.goOffline();}},_makeIframePollRequest:function(){var ba=s(window.location.href);if(ba.getSubdomain()=='our')ba=ba.setSubdomain('www');var ca=window.location.protocol+'//'+ba.getDomain()+'/',da=s(ca+this.config.csrf_uri).setQueryData({fb_csrf:this.fb_csrf,refresh_token:this.oauthTokenInvalid}),ea=s(this.uri.toString()+this.serverConfig.ops.GET_IFRAME_RESPONSE).setQueryData({set_csrf_path:da.toString(),cbust:this.serial++});this._cleanupIframe();this._iframe=k.create('iframe',{className:'hidden_elem',src:ea});x.debug('iframe_add',ea);document.body.appendChild(this._iframe);var fa=v;if(++this._iframeTryCount<this.config.iframeTryCycles){fa=function(){this._iframeTryCount>1&&x.debug('iframe_retry');this._makeIframePollRequest();};}else fa=function(){x.error('iframe_retry_exceeded');this._pingWebHelperModeResign();};this._iframePollTimeout=fa.bind(this).defer(this.config.iframeUpdatePeriod,false);},_cleanupIframe:function(){this._iframePollTimeout&&clearTimeout(this._iframePollTimeout);this._iframe&&x.debug('iframe_remove',this._iframe.id);this._iframe&&k.remove(this._iframe);this._iframe=null;},_switchToState:function(ba){x.debug('switch_state',this.state+" => "+ba);n.stateChanged.curry(p.SPOTIFY,this.state,ba).defer();this.inform(m.DIAGNOSTIC_EVENT.STATE_CHANGE,{from:this.state,to:ba});this.state=ba;},_convertURIFields:function(ba){if(!ba)return null;if(ba.track&&ba.track.track_resource){var ca=ba.track;ba.track={uri:ca.track_resource.location.og,name:ca.track_resource.name};if(ca.track_type)ba.track.track_type=ca.track_type;if(ca.artist_resource)ba.track.artist=ca.artist_resource.name;if(ca.album_resource)ba.track.album=ca.album_resource.name;if(ca.length){ba.playing_position=ba.playing_position?Math.floor(ba.playing_position):0;ba.expires_in=ca.length-ba.playing_position;ba.expires_in=ba.expires_in<0?0:ba.expires_in;}}if(ba.context&&ba.context.context_resource&&ba.context.context_resource.location){var da=ba.context;ba.context={uri:da.context_resource.location.og,name:da.context_resource.name};if(da.creator)ba.context.creator=da.creator.real_name;}for(var ea in ba)if(!m.ALLOWED_STATUS_PARAMS[ea])delete ba[ea];n.receiveUpdate.curry(p.SPOTIFY,ba).defer();return ba;},_isValidClient:function(ba,ca){var da=this._providerArgs.blacklisted_versions,ea=this._providerArgs.minimum_version;return this.PROTOCOL_VERSIONS.indexOf(ca)!==-1&&ea&&da&&ba&&da.indexOf(ba)===-1&&m.greaterOrEqualToMinimumVersion(ba,ea);},_getError:function(ba,ca){if(!ca&&!isNaN(parseFloat(ba)))if(ba>=4200&&ba<=4399)return this._errorMap['4200 - 4399'];return this._errorMap[ba];},_errorMap:{'4200 - 4399':'SERVICE_DEPENDENT_ERRORS',4201:1,4202:2,4203:3,4204:4,4205:5,4301:101,4302:102,4303:103,'4000 - 4099':'GENERAL_RPC_ERRORS',4001:'UNKNOWN_METHOD',4002:'ERROR_PARSING_REQUEST',4003:'UNKNOWN_SERVICE',4004:'SERVICE_NOT_RESPONDING','4100 - 4199':'RPC_AUTHENTICATION_ERRORS',4102:'LOGIN_BAD_CREDENTIALS',4103:'EXPIRED_OAUTH_TOKEN',4104:'OAUTH_TOKEN_NOT_VERIFIED',4105:'TOKEN_VERIFICATION_DENIED_TOO_MANY_REQUESTS',4106:'TOKEN_VERIFICATION_TIMEOUT',4107:'INVALID_CSRF_TOKEN',4108:'INVALID_OAUTH_FOR_CURRENT_USER',4109:'INVALID_CSRF_PATH',4110:'NO_USER_LOGGED_IN',LOAD_ERROR:'LOAD_ERROR',TIMEOUT_ERROR:'TIMEOUT_ERROR',PARSE_ERROR:'PARSE_ERROR'}});})();e.exports=a.SpotifyRemote||z;});
__d("WebBridgeRemote",["Event","Arbiter","ArbiterMixin","AsyncRequest","CSS","Dialog","DOM","Env","JSLogger","MusicConstants","MusicDiagnostics","ScubaSample","URI","UserAgent","copyProperties","cx","emptyFunction","ge","swfobject2"],function(a,b,c,d,e,f){var g=b('Event'),h=b('Arbiter'),i=b('ArbiterMixin'),j=b('AsyncRequest'),k=b('CSS'),l=b('Dialog'),m=b('DOM'),n=b('Env'),o=b('JSLogger'),p=b('MusicConstants'),q=b('MusicDiagnostics'),r=b('ScubaSample'),s=b('URI'),t=b('UserAgent'),u=b('copyProperties'),v=b('cx'),w=b('emptyFunction'),x=b('ge'),y=b('swfobject2'),z=o.create('music_web_bridge');function aa(ba,ca,da){this.responseCallback=ba;this.provider=ca;if(!da.external_player)return;this.externalPlayer=this._getExternalPlayer(da.external_player);this.connectionName=s(this.externalPlayer).getDomain();this.state=aa.STATES.OFFLINE;this.lastSentMsg=null;this.wasOnline=false;this.connectionAttempts=0;this.lastStatusCheck=0;h.subscribe('MusicFlashBridge.'+this.provider+'.status',this.reportStatus.bind(this));h.subscribe('MusicFlashBridge.'+this.provider+'.initialized',function(){this._flashBridgeReady.bind(this).defer();}.bind(this));t.osx()&&g.listen(window,'focus',this._onFocus.bind(this));t.osx()&&g.listen(window,'blur',this._onBlur.bind(this));}u(aa,{minFlashVersion:'10.3.181.34',flashBridgeSWF:'/music/flash/MusicFlashBridge.swf',configure:function(ba){z.debug('configure',ba);aa.minFlashVersion=ba.minFlashVersion;aa.flashBridgeSWF=ba.flashBridgeSWF;},STATES:{OFFLINE:'OFFLINE',BRIDGE_WAITING:'BRIDGE_WAITING',BRIDGE_READY:'BRIDGE_READY',ONLINE:'ONLINE'},PLAY_NOW_URL:'/ajax/music/web_bridge_play_now.php?init_only',ERROR_DIALOG:'/ajax/music/play_error.php',TOS_URL:'/music/tos_launch_player.php',OPTIMISTIC_PLAYNOW_TIME:2000,UNLOAD_ON_BLUR_DELAY:3000,REMOTE_CONNECTION_INTERVAL:1500,REMOTE_CONNECTION_TIMEOUT_MANUAL:60,REMOTE_CONNECTION_TIMEOUT_AUTO:p.CONFIG.PARTNER_TIMEOUT/1000,REMOTE_CONNECTION_RETRY_TIMEOUT:4000,RECHECK_STATUS_ON_SEND_INTERVAL:10000,RECHECK_STATUS_SEND_TIMEOUT:500,hasMinFlashVersion:function(){if(!y.hasFlashPlayerVersion(this.minFlashVersion)){z.bump('flash_upgrade');new j().setURI('/ajax/flash_update_dialog.php').setMethod('GET').setReadOnly(true).send();return false;}return true;},getFlashMovieObject:function(ba){if(document[ba])return document[ba];if(document.embeds&&document.embeds[ba])return document.embeds[ba];return x(ba);},removeFlashMovieObject:function(ba){if(document[ba])document[ba]=null;if(document.embeds&&document.embeds[ba])document.embeds[ba]=null;if(x(ba))m.remove(ba);}});u(aa.prototype,i,{responseCallback:w,flashBridge:null,persistFor:0,persistSearchingFor:function(ba){this.connectionAttempts=0;this.persistFor=ba;this.maxConnectAttempts=Math.floor((ba*1000)/aa.REMOTE_CONNECTION_INTERVAL);if(this.state===aa.STATES.OFFLINE)this._initFlashBridge();},attemptGoOnline:function(ba){var ca=ba?aa.REMOTE_CONNECTION_TIMEOUT_MANUAL:aa.REMOTE_CONNECTION_TIMEOUT_AUTO;if(ca<this.persistFor)ca=this.persistFor;this.persistSearchingFor(ca);},goOffline:function(){z.log('go_offline',{provider:this.provider,from_state:this.state});this._switchToState(aa.STATES.OFFLINE);this._removeFlashBridge();this._resetClientPoll();this.responseCallback(p.DIAGNOSTIC_EVENT.OFFLINE);},serviceRunning:function(){return this.state===aa.STATES.ONLINE;},reconnect:function(){},setTokens:function(ba){},send:function(ba,ca){if(this.state===aa.STATES.ONLINE){this._resetSendSubscription();var da=function(){this._resetSendSubscription();this.responseCallback(p.DIAGNOSTIC_EVENT.LOG_SEND_OP,{op:ba,params:ca});this._send(ba,p.sanitizeForProviders(ca));}.bind(this);if(Date.now()-aa.RECHECK_STATUS_ON_SEND_INTERVAL>this.lastStatusCheck){this._sendTimer=da.defer(aa.RECHECK_STATUS_SEND_TIMEOUT,false);this._sendSubscription=this.subscribe(p.DIAGNOSTIC_EVENT.MISS,function(ea,fa){q.stateChanged(this.provider,null,null,p.DIAGNOSTIC_EVENT.INCORRECT_ONLINE_STATE);this._resetSendSubscription();this.goOffline();this.responseCallback(p.DIAGNOSTIC_EVENT.REQUEUE_OP,{op:ba,params:ca});}.bind(this));this._send(p.STATUS_CHANGE_OP.STATUS,{});}else da();}else this.responseCallback(p.DIAGNOSTIC_EVENT.REQUEUE_OP,{op:ba,params:ca});},verifyOnlineState:function(ba){if(this.state!==aa.STATES.ONLINE){ba();}else{ba.defer(500,false);this._send(p.STATUS_CHANGE_OP.STATUS,{_never_queue:true});}},_resetSendSubscription:function(){this._sendTimer&&clearTimeout(this._sendTimer);this._sendSubscription&&this.unsubscribe(this._sendSubscription);this._sendSubscription=this._sendTimer=null;},_send:function(ba,ca){switch(ba){case p.OP.PLAY:case p.OP.RESUME:case p.OP.PAUSE:this.lastSentMsg={};u(this.lastSentMsg,ca);if(ca.radio_station||ca.album||ca.playlist||ca.musician){delete ca.song_list;}else if(!ca.song)ca.song=ca.uri;delete ca.uri;break;case p.STATUS_CHANGE_OP.STATUS:this.lastStatusCheck=Date.now();break;default:z.error('invalid_op',{provider:this.provider,op:ba});return;}if(this.flashBridge&&!this._unloadIfNeeded()){z.debug('send',{provider:this.provider,op:ba,params:ca});z.rate('flash_movie_valid',(typeof this.flashBridge.send)==='function');this.flashBridge.send(ba,ca);q.sendUpdate.curry(this.provider,ba,ca).defer();}},launch:function(ba,ca,da,ea,fa){var ga=this.provider.replace(/\.|-/g,'_'),ha=s(this.externalPlayer).addQueryData(ca),ia=ha;if(da){ia=s(aa.TOS_URL).addQueryData({player_url:ha.toString(),url:ba,perms:da,get_dtsg:n.fb_dtsg}).addQueryData(fa);}else{var ja=new r('music_launch',null,{addBrowserFields:true,addGeoFields:true,addUser:true});ja.addNormal('uses_bridge','1');ja.addNormal('provider',this.provider);ja.addNormal('class','WebBridgeRemote');ja.addNormal('new_install','0');ja.addDenorm('url',ba);ja.flush();}window.open(ia,ga);q.sendUpdate.curry(this.provider,q.WINDOW_OPEN,ca).defer();var ka={url:ba,step:9};if(ea)ka=u(ka,ea);z.debug('launch',{provider:this.provider,params:ka});this._launchPlayNow(ka);},launchPlayNowDialog:function(ba){if(this.serviceRunning())return;this._resetLaunchSubscription();var ca=this._launchPlayNow.bind(this,ba);this.prePlayNowLaunchTimer=ca.defer(aa.OPTIMISTIC_PLAYNOW_TIME,false);this.launchSubscription=this.subscribe([p.DIAGNOSTIC_EVENT.MISS,p.DIAGNOSTIC_EVENT.STATE_CHANGE],function(da,ea){if(da===p.DIAGNOSTIC_EVENT.MISS){this._resetLaunchSubscription();ca();}else if(ea.to===aa.STATES.ONLINE){this._resetLaunchSubscription();q.userAction.curry(this.provider,q.LAUNCH_NOT_NEEDED).defer();}}.bind(this));this.attemptGoOnline(true);},reportStatus:function(ba,ca){var da=ca.op,ea=ca.args;clearTimeout(this._pollTimeout);if(ea.error_code){q.userAction.curry(this.provider,p.DIAGNOSTIC_EVENT.SERVICE_ERROR,{code:ea.error_code}).defer();var fa=p.ERROR[ea.error_code];switch(fa){case 'AUDIO_AD_PLAYING':z.log('report_status_ad_playing',{error:fa,provider:this.provider,args:ea});break;default:var ga={code:ea.error_code,provider:this.provider};if(ea.song)ga.song=ea.song;if(ea.redirect_url)ga.url=ea.redirect_url;l.bootstrap(aa.ERROR_DIALOG,ga);z.error('report_status_error',{error:fa,provider:this.provider,args:ea});return;}}if(ea.offline){this.goOffline();}else if(da===p.DIAGNOSTIC_EVENT.MISS){this.inform(da,ea);if(this.state!==aa.STATES.ONLINE&&this.state!==aa.STATES.OFFLINE){if(this.connectionAttempts<this.maxConnectAttempts){this._pollForClient.bind(this).defer(aa.REMOTE_CONNECTION_INTERVAL,false);}else this.goOffline();}else if(this.state===aa.STATES.ONLINE){this.goOffline();if(this.lastSentMsg&&this.lastSentMsg.uri)this.responseCallback(p.DIAGNOSTIC_EVENT.RELAUNCH,{last_sent:this.lastSentMsg});return;}}else if(this.state===aa.STATES.BRIDGE_READY){this.wasOnline=true;this._switchToState(aa.STATES.ONLINE);this.responseCallback(p.DIAGNOSTIC_EVENT.ONLINE);}if(da===p.STATUS_CHANGE_OP.STATUS)q.receiveUpdate.curry(this.provider,ea).defer();if(ea.radio_station||ea.song){ea.track={};ea.track.uri=ea.radio_station||ea.song;ea.track.songuri=ea.song;}if(ea.radio_station){ea.context={name:ea.title,uri:ea.radio_station};}else if(ea.playlist){ea.context={name:ea.title,uri:ea.playlist};}else if(ea.album){ea.context={name:ea.title,uri:ea.album};}else if(ea.musician)ea.context={name:ea.title,uri:ea.musician};this.responseCallback.apply(this,[da].concat(ea));},_onFocus:function(){clearTimeout(this._blurTimeout);if(!this.wasOnline)return;if(!this.flashBridge){this.persistSearchingFor(aa.REMOTE_CONNECTION_TIMEOUT_AUTO);}else{z.rate('flash_movie_valid',(typeof this.flashBridge.activate)==='function');this.flashBridge.activate();}},_onBlur:function(){if(this.flashBridge){clearTimeout(this._blurTimeout);this._blurTimeout=function(){this._unloadIfNeeded();}.bind(this).defer(aa.UNLOAD_ON_BLUR_DELAY);}},_unloadIfNeeded:function(){if(this.flashBridge)if(t.osx()){var ba=(typeof this.flashBridge.shouldUnload==='function');z.rate('flash_movie_valid',ba);if(!ba||this.flashBridge.shouldUnload()){this.goOffline();return true;}}return false;},_launchPlayNow:function(ba){var ca=ba&&ba.context&&ba.context.button_id;this._resetLaunchSubscription();l.bootstrap(aa.PLAY_NOW_URL,ba,null,null,null,x(ca));},_resetLaunchSubscription:function(){clearTimeout(this.prePlayNowLaunchTimer);if(this.launchSubscription){var ba=this.launchSubscription;this.launchSubscription=undefined;this.unsubscribe(ba);}},_initFlashBridge:function(){this.flashBridge=aa.getFlashMovieObject(this.provider);if(!this.flashBridge){this._switchToState(aa.STATES.BRIDGE_WAITING);var ba=this.provider+'_container';document.body.appendChild(m.create('div',{id:ba}));y.embedSWF(aa.flashBridgeSWF,ba,'1px','1px',aa.minFlashVersion,null,{swf_id:this.provider,name:this.connectionName,user_id:n.user},{allowscriptaccess:'always'},null,function(ca){z.rate('flash_bridge_init',ca.success);z.debug('flash_bridge_init',ca.success);this.flashBridge=ca.ref;if(this.flashBridge)k.addClass(this.flashBridge,"_2px");}.bind(this));}else this._flashBridgeReady();},_removeFlashBridge:function(){if(this.flashBridge){z.debug('flash_bridge_unload',this.provider);var ba=this.provider+'_container';y.removeSWF(ba);this.flashBridge=null;}},_switchToState:function(ba){z.debug('switch_state',this.provider+": "+this.state+" => "+ba);q.stateChanged.curry(this.provider,this.state,ba).defer();this.inform(p.DIAGNOSTIC_EVENT.STATE_CHANGE,{from:this.state,to:ba});this.state=ba;},_flashBridgeReady:function(){z.debug('flash_bridge_ready',{provider:this.provider,state:this.state});if(this.state!=aa.STATES.ONLINE){this._switchToState(aa.STATES.BRIDGE_READY);this._pollForClient();}},_resetClientPoll:function(){this.connectionAttempts=0;this.persistFor=0;clearTimeout(this._pollTimeout);},_pollForClient:function(){if(!this.flashBridge||((typeof this.flashBridge.send)!=='function')||this.state==aa.STATES.OFFLINE)return;this._send(p.STATUS_CHANGE_OP.STATUS,{});var ba;if(++this.connectionAttempts<this.maxConnectAttempts){ba=function(){if(this.state==aa.STATES.OFFLINE)return;z.debug('poll_for_client',{provider:this.provider,connection_attempts:this.connectionAttempts});clearTimeout(this._pollTimeout);this._pollForClient();};}else ba=function(){z.debug('timeout_max_connection_attempts',this.provider);this.goOffline();};this._pollTimeout=ba.bind(this).defer(aa.REMOTE_CONNECTION_RETRY_TIMEOUT,false);},_getExternalPlayer:function(ba){return ba;}});e.exports=a.WebBridgeRemote||aa;});
__d("Music",["Arbiter","AsyncRequest","Bootloader","ChannelConstants","Dialog","JSLogger","MusicConstants","MusicDiagnostics","MusicEvents","MusicLogger","MusicProviders","Run","SpotifyRemote","WebBridgeRemote","areObjectsEqual","copyProperties","emptyFunction","ge","isEmpty"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i=b('Bootloader'),j=b('ChannelConstants'),k=b('Dialog'),l=b('JSLogger'),m=b('MusicConstants'),n=b('MusicDiagnostics'),o=b('MusicEvents'),p=b('MusicLogger'),q=b('MusicProviders'),r=b('Run'),s=b('SpotifyRemote'),t=b('WebBridgeRemote'),u=b('areObjectsEqual'),v=b('copyProperties'),w=b('emptyFunction'),x=b('ge'),y=b('isEmpty'),z=l.create('music'),aa={providers:{},queuedCommand:null,lastStatus:{},_searching:{},lastProviderPlaying:null,addRemoteModule:function(ba,ca){},init:function(ba,ca){z.debug('init',{music_providers:ba,reconnect:ca});for(var da in ba){this._setProviderConfig(da,v(this._getProviderConfig(da)||{offline:true},ba[da]));var ea=this._getProviderConfig(da),fa=this.getRemoteClass(da);fa.setTokens(ea.tokens,ea.last_used);ca&&fa.reconnect();}this.listenForScrobble();return this;},_getProviderConfig:function(ba){return this.providers[ba];},_getProviderConfigForLogging:function(ba){if(!this._hasProviderConfig(ba))return {};var ca=this._getProviderConfig(ba);return {offline:ca.offline,last_used:ca.last_used,instance:!!ca.instance};},_setProviderConfig:function(ba,ca){this.providers[ba]=ca;},_hasProviderConfig:function(ba){return !!this._getProviderConfig(ba);},persistSearchingFor:function(ba,ca){this._searching[ba]=true;var da;if(this._hasProviderConfig(ba))da=this.getRemoteClass(ba);da&&da.persistSearchingFor&&da.persistSearchingFor(ca);return this;},getRemoteClass:function(ba){if(!this._hasProviderConfig(ba)){z.error('provider_not_inited',ba);return null;}var ca=this._getProviderConfig(ba);if(!ca.instance){switch(ba){case q.SPOTIFY:var da=new s();da.init(this._receiveUpdate.bind(this,ba),ca);ca.instance=da;break;default:var ea=new t(this._receiveUpdate.bind(this,ba),ba,ca);ca.instance=ea;break;}if(!ca.instance)z.error('provider_module_not_loaded',ba);}return ca.instance;},listenForScrobble:function(){g.subscribe(j.getArbiterType('music_scrobbling'),function(ba,ca){if(ca.obj.provider_name){ca.obj.provider_data&&this.init(ca.obj.provider_data);this._resetQueuedCommand(ca.obj.provider_name);this.goOnline(ca.obj.provider_name);}}.bind(this));this.listenForScrobble=w;},goOnline:function(ba){var ca=(ba in this.providers);if(this._isOffline(ba)){var da=this.isManualPlay(ba),ea=ca&&this.getRemoteClass(ba);ea&&ea.attemptGoOnline(da);if(!this._searching[ba]&&da&&(!ea||!ea.serviceRunning())){this.persistSearchingFor(ba,60);this.launchPlayNowDialog(ba,this.queuedCommand.data);}}return this;},goOffline:function(ba,ca,da){if(this._hasProviderConfig(ba)){this._resetQueuedCommand(ba);this._searching[ba]=null;this.getRemoteClass(ba).goOffline();}return this;},allProvidersOffline:function(){for(var ba in this.providers)if(!this._isOffline(ba))return false;return true;},allProvidersPaused:function(){for(var ba in this.providers){var ca=this._getLastStatus(ba);if(ca&&ca.playing)return false;}return true;},playPauseSongList:function(ba,ca,da,ea,fa){v(fa||{},{song_list:da,title:ea||''});return this.playPauseSong(ba,ca,fa);},playPauseSong:function(ba,ca,da){if(!ba){ba=this.lastProviderPlaying;if(!ba)z.error('undefined_provider',ba);}z.debug('play_pause_song',{provider:ba,provider_config:this._getProviderConfigForLogging(ba),uri:ca,data:da});var ea=this._hasProviderConfig(ba)?this._getLastStatus(ba):{},fa=ea.track&&m.sameURLs(ca,ea.track.uri),ga=ea.context&&m.sameURLs(ca,ea.context.uri),ha=fa||ga;if(ea.playing&&ha){this.pause(ba,ca,da);}else if(ha){this.resume(ba,ca,da);}else this.playSong(ba,ca,da);return this._hasProviderConfig(ba)&&this.getRemoteClass(ba).serviceRunning();},pauseOtherProviders:function(ba){for(var ca in this.providers)if(ca!=ba&&!this._isOffline(ca))this.pause(ca);},launchProviderOrPlay:function(ba,ca,da,ea,fa,ga,ha,ia){if(fa){this._diagLogAction(fa,n.SWITCHED_PROVIDER);this.goOffline(fa);}if(!this._isOffline(ba)){this.playSong(ba,ca,da);var ja=k.getCurrent();ja&&ja.hide();}else if(ba==q.SPOTIFY){this.persistSearchingFor(ba,60);this._diagLogAction(ba,n.ATTEMPTING_LAUNCH,da);this.launchPlayNowDialog(ba,v({uri:ca},da),true);}else{!fa&&p.log(p.BUMP_KEY,{provider:ba,step:4,status:'okay'});var ka={};ka[ba]=ea;this.init(ka);this.launchBridgeProvider(ba,ca,da,ga,ha,ia);this.playSongSafeQueue(ba,ca,da);}},launchBridgeProvider:function(ba,ca,da,ea,fa,ga){if(ba==q.SPOTIFY)z.error('invalid_bridge_provider',ba);if(!this._isOffline(ba)){var ha=k.getCurrent();ha&&ha.hide();return;}this.persistSearchingFor(ba,60);var ia=m.sanitizeForProviders(da);this.getRemoteClass(ba).launch(ca,ia,ea,fa,ga);},launchPlayNowDialog:function(ba,ca,da){if(da)this.queuedCommand={provider:ba,op:m.OP.PLAY,data:ca};var ea=v({},ca),fa={url:ea.uri||ea.url,context:ea,listen_to:ea.listen_to||null,button_id:ea.button_id||null};delete fa.context.uri;delete fa.context.url;delete fa.context.listen_to;delete fa.context.button_id;if(this._hasProviderConfig(ba)){this.getRemoteClass(ba).launchPlayNowDialog(fa);}else{var ga;if(ba===q.SPOTIFY){ga='/ajax/music/spotify_play_now.php?init_only';}else ga='/ajax/music/web_bridge_play_now.php?init_only';k.bootstrap(ga,fa,null,null,null,x(fa.button_id));}},playSongSafeQueue:function(ba,ca,da){if(!this._isOffline(ba)||!this.queuedCommand||this.queuedCommand.provider!==ba){this.playSong(ba,ca,da);}else this._hasProviderConfig(ba)&&this.goOnline(ba);},playSong:function(ba,ca,da,ea){da=v(da||{},{uri:ca});if(ea&&ea.id&&!da.button_id)da.button_id=ea.id;this._sendOP(ba,m.OP.PLAY,da);},pause:function(ba,ca,da){da=v(da||{},{uri:ca||null});this._sendOP(ba,m.OP.PAUSE,da);},resume:function(ba,ca,da){da=v(da||{},{uri:ca});this._sendOP(ba,m.OP.RESUME,da);},reInform:function(ba){var ca=[];for(var da=0;da<ba.length;da++){var ea=ba[da];if(!this._isOffline(ea))if(ea==this.lastProviderPlaying){ca.push(ea);}else ca.unshift(ea);}for(var da=0;da<ca.length;da++){var ea=ca[da];z.debug('re_inform',ea);this._receive_STATUS_CHANGE_OP(ea,m.STATUS_CHANGE_OP.REINFORM,this.lastStatus[ea],{});}return this;},isManualPlay:function(ba){return !!(this.queuedCommand&&this.queuedCommand.provider===ba);},isPlaying:function(ba,ca){var da=this.getLastStatus(ba);return da.playing&&da.track&&(!ca||m.sameURLs(da.track.uri,ca));},getLastStatus:function(ba){return this._hasProviderConfig(ba)?this._getLastStatus(ba):{};},_resetQueuedCommand:function(ba){if(!ba||this.queuedCommand&&this.queuedCommand.provider==ba)this.queuedCommand=null;},_receiveUpdate:function(ba,ca,da){z.debug('receive_update',{provider:ba,op:ca,data:da,provider_config:this._getProviderConfigForLogging(ba)});if(da){da.provider=ba;}else da={provider:ba};var ea=w;if(m.DIAGNOSTIC_EVENT[ca]){ea=this._receiveDIAG_EVENT;}else if(m.STATUS_CHANGE_OP[ca]){ea=this._receive_STATUS_CHANGE_OP;}else !m.OP[ca];ea.call(this,ba,ca,da);},_receiveDIAG_EVENT:function(ba,ca,da){var ea=m.DIAGNOSTIC_EVENT;if(ca===ea.ONLINE){this._setOffline(ba,false);if(this.queuedCommand&&this.queuedCommand.provider==ba)r.onAfterLoad(this._replayQueuedCommand.bind(this,this.queuedCommand.provider,this.queuedCommand.op,this.queuedCommand.data));this._resetQueuedCommand();}else if(ca===ea.IFRAME_POLLING){this._setLastStatus(ba,{});}else if(ca===ea.RELAUNCH&&da.last_sent){this.launchPlayNowDialog(ba,da.last_sent,true);}else if(ca===ea.LOG_SEND_OP){this._logSendOp(ba,da.op,da.params,da.replay);}else if(ca===ea.REQUEUE_OP)this._queueAndGoOnline(ba,da.op,da.params);o.inform(ea[ca],da);if(ca===ea.OFFLINE){this._setOffline(ba,true);this._setLastStatus(ba,{});if(this.allProvidersOffline())o.inform(m.DIAGNOSTIC_EVENT.ALL_OFFLINE);}},_receive_STATUS_CHANGE_OP:function(ba,ca,da,ea){ea=ea||this._getLastStatus(ba);var fa;for(fa in ea)if(typeof da[fa]==='undefined')da[fa]=null;var ga,ha={};this._setLastStatus(ba,da);for(fa in da){ga=m.STATUS_CHANGE_EVENT[fa];if(ga)if(!ha[ga]&&!u(ea[fa],da[fa])){if(ca!==m.STATUS_CHANGE_OP.REINFORM)p.log(p.STATUS_EVENT_VIA,{op:ca,provider:ba,data:da});if(da.playing){if(this.lastProviderPlaying!=ba)this.pauseOtherProviders(ba);this.lastProviderPlaying=ba;}else if(this.allProvidersPaused())o.inform(m.DIAGNOSTIC_EVENT.ALL_PAUSED);o.inform(ga,da);ha[ga]=1;}}},_replayQueuedCommand:function(ba,ca,da){if(ca===m.OP.PLAY&&this.isPlaying(ba,da.uri))return;z.debug('replay_queued_command',ba+":"+ca);da.is_replayed_command=true;this._sendOP(ba,ca,da);},_sendOP:function(ba,ca,da){z.debug('send_op',{provider:ba,provider_config:this._getProviderConfigForLogging(ba),op:ca,data:da});if(!this._hasProviderConfig(ba)){this._queueAndGoOnline(ba,ca,da);}else this.getRemoteClass(ba).send(ca,da);},_logSendOp:function(ba,ca,da){var ea=ca===m.OP.PLAY;if(!da.is_replayed_command&&ea)this._diagLogAction(ba,n.LAUNCH_NOT_NEEDED);p.log(p.STATUS_EVENT_VIA,{op:ca,provider:ba,data:da});ea&&this._diagLogAction(ba,n.PLAY_SONG,da);},_queueAndGoOnline:function(ba,ca,da){z.debug('queue_and_go_online',{provider:ba,op:ca,data:da});if(!da._never_queue)this.queuedCommand={op:ca,data:da,provider:ba};if(ca===m.OP.PLAY)this._diagLogAction(ba,n.ATTEMPTING_LAUNCH,da);this.goOnline(ba);},_isOffline:function(ba){if(!this._hasProviderConfig(ba))return true;return this._getProviderConfig(ba).offline;},_setOffline:function(ba,ca){if(!this._hasProviderConfig(ba))return this;this._searching[ba]=null;this._getProviderConfig(ba).offline=ca;if(!ca&&!this.lastProviderPlaying){this.lastProviderPlaying=ba;}else if(ca&&this.lastProviderPlaying==ba){this.lastProviderPlaying=null;for(var da in this.providers)if(this.isPlaying(da)){this.lastProviderPlaying=da;break;}else if(!this._isOffline(da))this.lastProviderPlaying=da;}return this;},_getLastStatus:function(ba){if(!this._hasProviderConfig(ba))return {};return this.lastStatus[ba]||{};},_setLastStatus:function(ba,ca){if(!this._hasProviderConfig(ba))return this;this.lastStatus[ba]=ca;return this;},_diagLogAction:function(ba,ca,da){n.userAction.curry(ba,ca,da).defer();}};e.exports=aa;a.Music=aa;});